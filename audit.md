# Audit Notes

## Single Sources of Truth
- Field Names: `config/optimized_field_mapping.yaml` loaded via `utils/yaml_field_loader.py` helpers (`resolve_session_field()`, `resolve_calculated_field()`), with volume fields coordinated in `core/data/volume_state_manager.py`.
- Data Schemas: `config/schemas.py` standardizes tick/session/indicator records for every processing pipeline stage.
- Volume State: `core/data/volume_state_manager.py` (and VolumeProfileManager integration) is the only component calculating incremental and session-aware volume metrics.
- Volume Averages (20d/55d): `config/volume_averages_20d.json` generated by `utils/update_all_20day_averages.py`, loaded via `load_volume_averages_to_redis.py`, accessed Redis-first with JSON fallback.
- Token Resolution: `core/data/token_lookup.json` with DuckDB-backed `token_resolver.py` powering `TokenResolver.resolve_token_to_symbol()` across services.
- Pattern Detection: `patterns/pattern_detector.py` registry (`patterns/data/pattern_registry_config.json`) atop `patterns/base_detector.py`, with shared math engine in `patterns/pattern_mathematics.py`.

## Audit Findings (In Progress)
- ‚úÖ `patterns/pattern_mathematics.py:40` now has a single `get_vix_aware_rsi_thresholds()` implementation that documents and returns float vs `(low, high)` tuple behaviour; duplicate definition removed.
- ‚úÖ `patterns/pattern_detector.py:3512` now resolves legacy fields via `resolve_session_field()` so the canonical YAML mapping stays authoritative.
- ‚úÖ ICT modules relocated to `patterns/ict/` with central imports (`patterns/ict/pattern_detector.py`) so they now consume `PatternMathematics` and shared schema helpers directly; `core/data/redis_storage.py` updated to use the new package.
- ‚úÖ Legacy volume helpers now proxy to the centralized baseline; `utils/calculations.py:1885` (`normalize_volume`) and `utils/calculations.py:2257` (`calculate_volume_ratio_with_redis_fallback`) call `CorrectVolumeCalculator` instead of applying hard-coded 10x caps.
- üîß `scanner_main.py:3850-3910` now reads the canonical `volume_ratio` supplied by ingestion (with a VIX-aware threshold fallback) instead of invoking `normalize_volume()`; Redis validation no longer recalculates ratios or clamps them to 10x.
- ‚úÖ `utils/calculations.py` routes batch/real-time indicator volume ratios through `VolumeResolver` with a `CorrectVolumeCalculator` fallback; legacy helpers (`normalize_volume`, `calculate_volume_ratio_with_redis_fallback`) now delegate to the centralized engine.
- ‚úÖ `strategies/nifty_scalper.py:249` stops recomputing ratios from static averages and consumes the session-provided volume ratios when available.
- üîç Review whether any remaining code relies on `utils.calculations.normalize_volume`; it is legacy and should be removed once downstream callers migrate to the centralized mechanisms.
